<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema Beauty</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9;}
    header {background: #d63384; color: #fff; padding: 10px; text-align: center;}
    nav {display: flex; background: #f1f1f1;}
    nav button {flex: 1; padding: 10px; border: none; cursor: pointer; background: #f1f1f1;}
    nav button.active {background: #d63384; color: #fff;}
    section {display: none; padding: 20px;}
    section.active {display: block;}
    table {width: 100%; border-collapse: collapse; margin-top: 10px;}
    th, td {border: 1px solid #ccc; padding: 5px; text-align: left;}
    .hidden {display: none;}
    .promo-col {background: #ffe6f0;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Sistema Beauty</h1>
  </header>

  <div id="loginScreen">
    <h2>Login</h2>
    <input type="password" id="loginPass" placeholder="Digite a senha">
    <button onclick="doLogin()">Entrar</button>
  </div>

  <div id="mainApp" class="hidden">
    <nav>
      <button onclick="showSection('cadastro')" class="active">Cadastro</button>
      <button onclick="showSection('agendamento')">Agendamento</button>
      <button onclick="showSection('consultas')">Consultas</button>
      <button onclick="showSection('pagamento')">Caixa</button>
      <button onclick="togglePromocao()">Promoção</button>
    </nav>

    <section id="cadastro" class="active">
      <h2>Cadastro de Cliente</h2>
      <form id="formCadastro">
        <input type="text" id="nome" placeholder="Nome" required>
        <input type="date" id="nascimento" required>
        <input type="number" id="idade" placeholder="Idade" readonly>
        <input type="text" id="telefone" placeholder="Telefone" required>
        <input type="text" id="genero" placeholder="Gênero">
        <input type="email" id="email" placeholder="Email">
        <input type="text" id="cep" placeholder="CEP">
        <input type="text" id="endereco" placeholder="Endereço">
        <input type="text" id="complemento" placeholder="Complemento">
        <input type="text" id="whatsapp" placeholder="Número WhatsApp">
        <button type="submit">Cadastrar</button>
      </form>
      <table id="clientesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Nascimento</th>
            <th>Telefone</th>
            <th class="promo hidden">Consultas Concluídas</th>
            <th class="promo hidden">Cupons</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="agendamento">
      <h2>Agendamento</h2>
      <input type="date" id="agendaData">
      <input type="time" id="agendaHora">
      <select id="agendaCliente"></select>
      <button onclick="agendarConsulta()">Agendar</button>
      <div id="listaAgendamentos"></div>
    </section>

    <section id="consultas">
      <h2>Consultas</h2>
      <input type="date" id="consultaData" onchange="mostrarConsultasDia()">
      <div id="listaConsultas"></div>
    </section>

    <section id="pagamento">
      <h2>Controle de Caixa</h2>
      <input type="number" id="valorEntrada" placeholder="Valor Entrada">
      <input type="text" id="descEntrada" placeholder="Descrição Entrada">
      <button onclick="registrarEntrada()">Registrar Entrada</button>
      <br>
      <input type="number" id="valorSaida" placeholder="Valor Saída">
      <input type="text" id="descSaida" placeholder="Descrição Saída">
      <button onclick="registrarSaida()">Registrar Saída</button>
      <h3>Saldo Atual: R$ <span id="saldoAtual">0</span></h3>
      <button onclick="exportarPDF()">Exportar PDF</button>
      <div id="movimentos"></div>
    </section>
  </div>

<script>
let clientes = JSON.parse(localStorage.getItem('clientes')||'[]');
let agendamentos = JSON.parse(localStorage.getItem('agendamentos')||'[]');
let caixa = JSON.parse(localStorage.getItem('caixa')||'[]');
let promocaoAtiva = false;

function doLogin(){
  if(document.getElementById('loginPass').value==="3001"){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    renderClientes();
    renderMovimentos();
  } else alert("Senha incorreta");
}
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
}
function togglePromocao(){
  promocaoAtiva = !promocaoAtiva;
  document.querySelectorAll('.promo').forEach(el=>el.classList.toggle('hidden',!promocaoAtiva));
  renderClientes();
}

// Cadastro cliente
function gerarID(){return Math.floor(100+Math.random()*900);} 

document.getElementById('nascimento').addEventListener('change',()=>{
  let nasc=new Date(document.getElementById('nascimento').value);
  let diff=Date.now()-nasc.getTime();
  let age=new Date(diff).getUTCFullYear()-1970;
  document.getElementById('idade').value=age;
});

document.getElementById('formCadastro').addEventListener('submit',e=>{
  e.preventDefault();
  let c={
    id: gerarID(),
    nome: nome.value,
    nascimento: nascimento.value,
    idade: idade.value,
    telefone: telefone.value,
    genero: genero.value,
    email: email.value,
    cep: cep.value,
    endereco: endereco.value,
    complemento: complemento.value,
    whatsapp: whatsapp.value,
    consultas: 0,
    cupons: []
  };
  clientes.push(c);
  salvarClientes();
  renderClientes();
  e.target.reset();
});

function salvarClientes(){localStorage.setItem('clientes',JSON.stringify(clientes));}

function renderClientes(){
  let tb=document.querySelector('#clientesTable tbody');
  tb.innerHTML='';
  clientes.forEach(c=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.id}</td><td><a href="#" onclick="editarCliente(${c.id})">${c.nome}</a></td><td>${c.nascimento}</td><td>${c.telefone}</td>`+
    (promocaoAtiva?`<td>${c.consultas}</td><td>${c.cupons.map(cp=>`<a href='#' onclick=\"usarCupom(${c.id},'${cp}')\">${cp}</a>`).join(', ')}</td>`:'')+
    `<td><button onclick="excluirCliente(${c.id})">Excluir</button></td>`;
    tb.appendChild(tr);
  });
  atualizarAgendaClientes();
}
function excluirCliente(id){
  clientes=clientes.filter(c=>c.id!=id);
  salvarClientes();renderClientes();
}

// Agendamento
function atualizarAgendaClientes(){
  let sel=document.getElementById('agendaCliente');
  sel.innerHTML=clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
}
function agendarConsulta(){
  let data=agendaData.value, hora=agendaHora.value, id=agendaCliente.value;
  if(!data||!hora||!id){alert("Preencha tudo");return;}
  agendamentos.push({data,hora,id,concluida:false});
  localStorage.setItem('agendamentos',JSON.stringify(agendamentos));
  listarAgendamentos();
}
function listarAgendamentos(){
  let div=document.getElementById('listaAgendamentos');
  div.innerHTML='';
  agendamentos.forEach((a,i)=>{
    let c=clientes.find(cl=>cl.id==a.id);
    div.innerHTML+=`<div>${a.data} ${a.hora} - ${c?c.nome:''} ${!a.concluida?`<button onclick="concluirConsulta(${i})">Concluir</button>`:''}</div>`;
  });
}
function concluirConsulta(i){
  agendamentos[i].concluida=true;
  localStorage.setItem('agendamentos',JSON.stringify(agendamentos));
  let c=clientes.find(cl=>cl.id==agendamentos[i].id);
  if(c){
    c.consultas++;
    if(c.consultas>=10){
      c.consultas=0;
      let cupom = "BEAUTY "+Math.floor(1000+Math.random()*9000);
      c.cupons.push(cupom);
      alert("Cliente ganhou um cupom: "+cupom);
      // Envio automático por WhatsApp
      if(c.whatsapp){
        let msg = encodeURIComponent(`Olá ${c.nome}, você ganhou um cupom: ${cupom}`);
        window.open(`https://wa.me/${c.whatsapp}?text=${msg}`, '_blank');
      }
    }
    salvarClientes();renderClientes();
  }
  listarAgendamentos();
  showSection('pagamento');
}

// Consultas
function mostrarConsultasDia(){
  let d=consultaData.value;
  let div=document.getElementById('listaConsultas');
  div.innerHTML='';
  agendamentos.filter(a=>a.data==d).forEach(a=>{
    let c=clientes.find(cl=>cl.id==a.id);
    div.innerHTML+=`<div>${a.hora} - ${c?`<a href='#' onclick=\"editarCliente(${c.id})\">${c.nome}</a>`:''} <button onclick="concluirConsulta(${agendamentos.indexOf(a)})">Concluir</button></div>`;
  });
}

function usarCupom(id, cupom){
  if(confirm("Deseja usar o cupom "+cupom+"?")){
    let c=clientes.find(cl=>cl.id==id);
    c.cupons=c.cupons.filter(cp=>cp!=cupom);
    salvarClientes();renderClientes();
    if(c.whatsapp){
      let msg = encodeURIComponent(`Olá ${c.nome}, seu cupom ${cupom} foi utilizado.`);
      window.open(`https://wa.me/${c.whatsapp}?text=${msg}`, '_blank');
    }
  }
}

// Caixa
function registrarEntrada(){
  let v=parseFloat(valorEntrada.value); if(isNaN(v)) return;
  caixa.push({tipo:'entrada',valor:v,desc:descEntrada.value});
  localStorage.setItem('caixa',JSON.stringify(caixa));
  renderMovimentos();
}
function registrarSaida(){
  let v=parseFloat(valorSaida.value); if(isNaN(v)) return;
  caixa.push({tipo:'saida',valor:v,desc:descSaida.value});
  localStorage.setItem('caixa',JSON.stringify(caixa));
  renderMovimentos();
}
function renderMovimentos(){
  let div=document.getElementById('movimentos');
  div.innerHTML='';
  let saldo=0;
  caixa.forEach(m=>{
    div.innerHTML+=`<div>${m.tipo.toUpperCase()} R$${m.valor} - ${m.desc}</div>`;
    saldo+= m.tipo==='entrada'?m.valor:-m.valor;
  });
  document.getElementById('saldoAtual').innerText=saldo;
}

// Exportar PDF refinado com jsPDF
function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Relatório de Caixa", 20, 20);
  let y=40;
  caixa.forEach(m=>{
    doc.setFontSize(12);
    doc.text(`${m.tipo.toUpperCase()} - R$ ${m.valor} - ${m.desc}`, 20, y);
    y+=10;
  });
  doc.setFontSize(14);
  let saldo=caixa.reduce((s,m)=>s+(m.tipo==='entrada'?m.valor:-m.valor),0);
  doc.text("Saldo atual: R$ "+saldo,20,y+10);
  doc.save("Relatorio_Caixa.pdf");
}

// inicializar
listarAgendamentos();
</script>
</body>
</html>

